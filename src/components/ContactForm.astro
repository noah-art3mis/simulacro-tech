---
import { Send } from 'lucide-astro';
---

<div class="w-full max-w-2xl mx-auto">
	<form
		id="contact-form"
		action="https://formspree.io/f/xpwvlovb"
		class="glass-card rounded-2xl p-8 space-y-6"
		target="_top"
		method="POST"
	>
		<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
			<div class="space-y-2">
				<label class="block text-sm font-medium text-[var(--color-text-muted)]" for="name">
					Name
				</label>
				<input
					class="w-full h-12 rounded-xl border border-[var(--color-border)] bg-[var(--color-bg)] px-4 text-[var(--color-text)] placeholder:text-[var(--color-text-muted)]/50 focus:outline-none focus:border-[var(--color-accent)] transition-colors"
					id="name"
					name="name"
					type="text"
					placeholder="Your name"
					required
				/>
			</div>

			<div class="space-y-2">
				<label class="block text-sm font-medium text-[var(--color-text-muted)]" for="email">
					Email
				</label>
				<input
					class="w-full h-12 rounded-xl border border-[var(--color-border)] bg-[var(--color-bg)] px-4 text-[var(--color-text)] placeholder:text-[var(--color-text-muted)]/50 focus:outline-none focus:border-[var(--color-accent)] transition-colors"
					id="email"
					name="email"
					type="email"
					placeholder="you@example.com"
					required
				/>
			</div>
		</div>

		<div class="space-y-2">
			<label class="block text-sm font-medium text-[var(--color-text-muted)]" for="message">
				Message
			</label>
			<textarea
				class="w-full min-h-[160px] resize-none rounded-xl border border-[var(--color-border)] bg-[var(--color-bg)] px-4 py-3 text-[var(--color-text)] placeholder:text-[var(--color-text-muted)]/50 focus:outline-none focus:border-[var(--color-accent)] transition-colors"
				id="message"
				name="message"
				placeholder="Tell me about your project..."
				required
			></textarea>
		</div>

		<div class="flex justify-end">
			<button
				class="btn-primary inline-flex items-center gap-2"
				type="submit"
			>
				Send Message
				<Send size={16} />
			</button>
		</div>
	</form>

	<div id="error" class="glass-card rounded-xl p-4 text-sm text-red-400 border-red-400/30 hidden mt-6"></div>

	<div id="success" class="glass-card rounded-xl p-8 text-center hidden mt-6">
		<div class="w-16 h-16 rounded-full bg-[var(--color-accent)]/10 flex items-center justify-center mx-auto mb-4">
			<svg class="w-8 h-8 text-[var(--color-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
			</svg>
		</div>
		<p class="text-lg font-semibold mb-2">Thank you!</p>
		<p class="text-sm text-[var(--color-text-muted)] mb-6">I'll get back to you soon.</p>
		<button
			type="button"
			id="send-another"
			class="text-sm text-[var(--color-accent)] hover:underline"
		>
			Send another message
		</button>
	</div>
</div>

<script>
	const form = document.getElementById('contact-form') as HTMLFormElement;
	const errorDiv = document.getElementById('error');
	const successDiv = document.getElementById('success');
	const sendAnotherBtn = document.getElementById('send-another');

	if (form && errorDiv && successDiv && sendAnotherBtn) {
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			errorDiv.classList.add('hidden');
			successDiv.classList.add('hidden');

			const formData = new FormData(form);
			const name = formData.get('name') as string;
			const email = formData.get('email') as string;
			const message = formData.get('message') as string;

			if (!name || !email || !message) {
				errorDiv.textContent = 'Please fill in all fields.';
				errorDiv.classList.remove('hidden');
				return;
			}

			if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
				errorDiv.textContent = 'Please enter a valid email address.';
				errorDiv.classList.remove('hidden');
				return;
			}

			// Submit to Formspree
			try {
				const response = await fetch(form.action, {
					method: 'POST',
					body: formData,
					headers: {
						'Accept': 'application/json'
					}
				});

				if (response.ok) {
					const contentType = response.headers.get('content-type');
					if (contentType && contentType.includes('application/json')) {
						const data = await response.json();
						if (data.next || data.ok !== false) {
							form.classList.add('hidden');
							successDiv.classList.remove('hidden');
						} else {
							errorDiv.textContent = data.error || 'Something went wrong. Please try again.';
							errorDiv.classList.remove('hidden');
						}
					} else {
						form.classList.add('hidden');
						successDiv.classList.remove('hidden');
					}
				} else if (response.status === 302) {
					form.classList.add('hidden');
					successDiv.classList.remove('hidden');
				} else {
					try {
						const data = await response.json();
						errorDiv.textContent = data.error || 'Something went wrong. Please try again.';
					} catch {
						errorDiv.textContent = `Error: ${response.status} ${response.statusText}. Please try again.`;
					}
					errorDiv.classList.remove('hidden');
				}
			} catch (error) {
				console.error('Form submission error:', error);
				errorDiv.textContent = 'Network error. Please check your connection and try again.';
				errorDiv.classList.remove('hidden');
			}
		});

		sendAnotherBtn.addEventListener('click', () => {
			form.reset();
			form.classList.remove('hidden');
			successDiv.classList.add('hidden');
			errorDiv.classList.add('hidden');
		});
	}
</script>
